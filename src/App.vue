<template>
  <div id="app">
    <b-navbar centered spaced shadow>
      <template slot="brand">
        <b-navbar-item tag="router-link" :to="{ path: '/' }" class="py-0">
          <!-- <img src="./assets/logo_text.png" alt="" /> -->
          <svg xmlns="http://www.w3.org/2000/svg" width="106.847" height="50"><switch><g><path fill="none" d="M32.234 36.435c2.588-.009 5.177-.005 7.765-.005.75 0 .738 0 .752-.744.005-.271-.09-.32-.337-.318-1.366.011-2.733.005-4.1.005h-3.696c-.729 0-.713 0-.733.726-.009.283.084.337.349.336zM32.235 31.228c2.57-.009 5.139-.005 7.709-.005.792 0 .782 0 .786-.796.001-.238-.075-.296-.303-.293-1.367.009-2.735.004-4.103.004h-3.669c-.767 0-.753 0-.772.754-.006.284.087.337.352.336zM40.728 40.851c.028-.261-.085-.308-.319-.305-.984.011-1.969.005-2.953.005-1.751 0-3.503.003-5.254-.005-.238-.001-.343.052-.314.308.021.184.022.375 0 .558-.035.292.053.386.365.382 1.357-.019 2.715-.009 4.073-.009 1.161 0 2.322.005 3.482-.002.296-.002.685.133.865-.061.174-.189.023-.575.055-.871z"/><path fill="#E67865" d="M49.969 44.682c-.005-5.762-.002-11.522-.004-17.285 0-.185-.014-.371-.033-.557-.04-.384-.263-.619-.629-.719a3.759 3.759 0 00-.98-.132c-8.01.002-16.02.002-24.029.002-.104 0-.208-.002-.312.005-.907.072-1.363.469-1.364 1.206-.002 5.886-.001 11.772 0 17.657 0 .493.198.77.651.95.352.139.724.161 1.153.203-.341.587-.651 1.149-.987 1.693-.227.366-.19.708.024 1.048.401.635 1.028.909 1.738.92 1.668.027 3.337.005 5.004.003 1.032-.002 1.826-.406 2.377-1.309.422-.69.804-1.4 1.196-2.105.11-.197.229-.276.458-.273 1.336.01 2.673.011 4.01-.001.249-.002.388.073.515.292.475.824.917 1.67 1.491 2.435.292.389.619.729 1.122.825.376.073.754.138 1.138.139 1.596.004 3.192.017 4.788-.001.626-.008 1.205-.204 1.646-.684.42-.458.457-.849.151-1.375l-.934-1.601c.257-.025.475-.031.687-.069 1.058-.195 1.124-.46 1.123-1.267zM32.656 30.137h3.669c1.368 0 2.736.005 4.103-.004.228-.002.304.055.303.293-.003.796.007.796-.786.796-2.57 0-5.14-.004-7.709.005-.265.001-.358-.051-.352-.336.018-.754.005-.754.772-.754zm-.039 5.236h3.696c1.367 0 2.734.006 4.1-.005.248-.001.342.048.337.318-.014.744-.001.744-.752.744-2.588 0-5.177-.004-7.765.005-.265.001-.358-.053-.35-.337.021-.725.006-.725.734-.725zm7.971 6.381c-.184.043-.484.027-.781.03-1.161.007-2.321.002-3.482.002-1.357 0-2.715-.01-4.073.009-.312.003-.4-.091-.365-.382a2.422 2.422 0 000-.558c-.029-.256.076-.309.314-.308 1.751.009 3.503.005 5.254.005.984 0 1.969.005 2.953-.005.234-.002.32.043.319.305 0 .296.095.847-.139.902z"/><path fill-rule="evenodd" clip-rule="evenodd" fill="#E67865" d="M36.222 13.997c-4.001 0-8.002 0-12.002-.002-.279 0-.56-.009-.837-.041-1.069-.114-1.511-.803-1.619-1.708a5.687 5.687 0 01.058-1.826c.195-.948.697-1.352 1.769-1.392.684-.026 1.368-.015 2.052-.016 1.855-.001 3.71-.004 5.565.007.252.001.307-.075.305-.313-.009-.804-.001-.804-.806-.804l-6.747-.001c-.291-.001-.578-.001-.867-.054-.903-.169-1.375-.622-1.521-1.521a5.698 5.698 0 01.032-2.009c.173-.893.55-1.23 1.46-1.326.309-.033.62-.05.93-.05 2.394-.004 4.788-.005 7.182.004.249.001.328-.054.342-.317.059-1.053 1-2.019 2.05-2.069a56.32 56.32 0 015.467.002c1.094.055 1.918.945 1.967 2.077.011.249.085.306.322.305 2.466-.008 4.933-.008 7.399-.001.486.001.972.041 1.435.219.339.131.595.346.697.699.259.9.312 1.819.081 2.728-.216.849-.824 1.26-1.855 1.298-.714.026-1.43.015-2.146.015-1.876.002-3.752.005-5.627-.004-.226 0-.325.05-.299.292.02.174.022.354 0 .528-.032.26.084.301.316.3 2.341-.006 4.684-.003 7.027-.005.425 0 .848.023 1.264.125.548.133.916.454 1.065 1.011.207.772.243 1.559.092 2.338-.187.96-.808 1.431-1.896 1.497-.227.014-.455.013-.683.013l-11.972.001zM70.499 32.984c0 3.482.01 6.965-.006 10.448-.004 1.147-.207 2.266-.735 3.303-.624 1.227-1.661 1.951-2.927 2.396-1.178.414-2.401.535-3.636.548-1.658.017-3.316.002-4.974.005-.261.001-.516-.044-.771-.088-.579-.1-.85-.436-1.001-1.394-.031-.192-.021-.393-.021-.588 0-2.436-.001-4.871.001-7.307 0-.269.004-.541.049-.805.17-1.006.5-1.265 1.564-1.384.897-.101 1.802-.028 2.703-.042.343-.006.679-.026 1.011-.136.391-.127.677-.359.825-.739.193-.494.318-1.006.318-1.541 0-4.394.003-8.789-.004-13.182a2.85 2.85 0 01.416-1.534c.338-.556.829-.844 1.458-.854a91.697 91.697 0 013.854.001c1.019.025 1.822.93 1.871 2.043.017.382.008.766.008 1.15v9.7h-.003z"/><path fill="none" d="M28.616 19.585h-.062c-.472.008-.407-.063-.411.411-.004.637-.001.637.625.637.114 0 .229-.013.342.003.235.032.296-.064.294-.295-.008-.756.002-.756-.788-.756zM36.336 19.585h-.186c-.498.008-.43-.07-.434.45-.004.598-.001.598.631.598.568 0 .568 0 .568-.532 0-.516 0-.516-.579-.516zM43.852 19.585c-.703 0-.703 0-.7.715 0 .041.004.083-.001.124-.019.165.059.217.217.211.237-.01.475 0 .713-.002.473-.004.415.055.417-.407.004-.641.002-.641-.646-.641z"/><path fill="#E67866" d="M50.719 16.445c-.001-.541-.301-.919-.82-1.079-.35-.108-.714-.112-1.076-.112-8.329-.002-16.659-.002-24.99 0-.268 0-.537.013-.805.043-.634.068-1.138.593-1.139 1.233-.011 2.33-.007 4.662-.003 6.992 0 .399.158.708.515.928.374.229.776.274 1.191.274 4.237.002 8.475.002 12.712.002 4.217 0 8.433 0 12.65-.002.236 0 .477-.016.711-.051.686-.106 1.052-.45 1.054-1.017.007-2.404.006-4.807 0-7.211zM29.11 20.637c-.112-.016-.228-.003-.342-.003-.626 0-.628 0-.625-.637.003-.474-.061-.403.411-.411h.062c.79 0 .78 0 .788.756.002.231-.059.326-.294.295zm7.237-.004c-.632 0-.635 0-.631-.598.004-.521-.064-.442.434-.45h.186c.579 0 .579 0 .579.516 0 .532 0 .532-.568.532zm7.735 0c-.238.002-.476-.007-.713.002-.159.006-.236-.046-.217-.211.005-.041.001-.083.001-.124-.003-.715-.003-.715.7-.715.648 0 .65 0 .646.641-.002.462.056.403-.417.407z"/><path fill-rule="evenodd" clip-rule="evenodd" fill="#E67865" d="M83.309 15.046c-1.855 0-3.709.014-5.564-.005-1.463-.016-2.918-.135-4.298-.685-1.719-.684-2.715-1.929-2.898-3.798-.084-.86-.037-1.719-.043-2.578-.011-1.658-.001-3.315-.005-4.974 0-.25.027-.496.089-.737.252-.966.96-1.52 1.967-1.527C73.738.735 74.919.765 76.1.735c1.396-.038 1.996 1.049 2.11 1.999.023.195.01.394.026.589.065.775 1.032 1.742 2.023 1.73 3.005-.036 6.009-.013 9.014-.011.441 0 .868.083 1.259.287.662.345 1.013.889 1.018 1.65.009 2.04.018 4.081-.007 6.121-.013 1.152-.932 1.937-2.142 1.943-2.031.008-4.062.003-6.092.003zM10.546 9.137c2.673 0 5.347.003 8.02-.001.785-.001 1.404.292 1.85.946.181.266.283.558.299.871.048.941.086 1.89-.006 2.825-.111 1.136-.881 1.781-2.029 1.827-.082.002-.166.001-.249.001H2.67c-1.398 0-2.199-.797-2.202-2.194-.001-.705.042-1.413-.01-2.113-.084-1.148.965-2.196 2.162-2.176 2.641.046 5.284.014 7.926.014zM10.45 24.382h6.218c1.454 0 2.287.836 2.29 2.299 0 .633-.042 1.269.009 1.896.111 1.381-.952 2.353-2.326 2.338-3.088-.035-6.175-.012-9.264-.012-1.109 0-2.218.005-3.327 0-1.002-.006-1.825-.664-2.044-1.625a1.806 1.806 0 01-.039-.401c-.004-.798-.007-1.595-.001-2.394.009-1.199.913-2.097 2.112-2.099 2.123-.004 4.247-.002 6.372-.002zM10.452 1.293c2.103 0 4.207.038 6.308-.015 1.286-.032 2.27 1.027 2.205 2.195-.041.723-.047 1.453.002 2.174.066.936-.775 2.113-2.067 2.113-4.309 0-8.618.007-12.927-.004-1.126-.003-2.003-.926-2.009-2.06-.004-.756.035-1.515-.009-2.268-.06-1.02.87-2.182 2.158-2.149 2.112.054 4.226.014 6.339.014z"/><path fill-rule="evenodd" clip-rule="evenodd" fill="#E67866" d="M10.422 16.806c2.093 0 4.186.005 6.279-.001.697-.002 1.299.196 1.776.73.287.322.449.688.474 1.118.053.901.023 1.802 0 2.701-.022.858-.809 1.721-1.662 1.832a5.453 5.453 0 01-.711.046c-4.145.003-8.289.003-12.433.001-1.067 0-1.96-.668-2.146-1.616-.043-.22-.032-.453-.034-.681-.004-.652.042-1.308-.011-1.958-.092-1.139.905-2.195 2.19-2.179 2.092.027 4.185.009 6.278.007z"/><path fill="#E67865" d="M105.476 31.694a1.52 1.52 0 00-.472-.767c-.23-.305-.581-.469-1.056-.478a142.433 142.433 0 00-4.427-.001c-.748.011-.884.392-1.05 1.127-.087.387-.075 2.868-.075 2.924-.008 1.037-.032 2.075-.051 3.109 0 .041.059.83 0 1.188-.013.08-.204.343-.422.547-.259.243-.779.25-.869.25H81.538c-.809 0-.896-1.513-.896-2.326v-.342c0-5.773-.067-11.546-.065-17.32 0-.353-.052-.703-.1-1.053-.126-.939-.6-1.428-1.464-1.443a146.468 146.468 0 00-4.64-.001c-.783.012-1.215.41-1.388 1.181-.091.405-.11.82-.11 1.234.001 9.121-.001 18.242.001 27.363 0 .383.019.767.053 1.148.083.929.461 1.365 1.312 1.516.274.048.552.074.834.074 4.705-.003 9.41-.002 14.116-.002 4.685 0 9.37-.001 14.055.002.302 0 .601-.024.897-.068.832-.125 1.141-.39 1.343-1.221.101-.405.155-.816.155-1.232V32.862a4.37 4.37 0 00-.165-1.168z"/><path fill="#E67865" d="M97.124 23.818c-3.073-3.743-6.346 0-6.346 0s-3.264-3.743-6.337 0c-.704.86-1.063 2.952-.007 4.446 1.551 2.195 5.817 5.1 6.344 5.1.525 0 4.798-2.905 6.349-5.1 1.057-1.494.702-3.586-.003-4.446zM19.655 33.347c-.474-.759-1.185-1.408-2.048-1.408-2.412-.003-4.826-.345-7.237-.345H5.732c-.932 0-1.865.334-2.797.346-1.146.014-2.026 1.073-2.026 2.208C.907 38.53.92 42.999.9 47.381c-.006 1.04.82 2.242 2.17 2.213 2.413-.054 4.828.006 7.242.006 2.445 0 4.891.012 7.336.009 1.387-.002 2.268-.856 2.27-2.235.007-4.311.003-8.619 0-12.929 0-.384-.051-.759-.263-1.098zm-5.284 7.924c-.968 1.37-3.634 3.183-3.962 3.183-.327 0-2.99-1.813-3.958-3.183-.659-.931-.435-2.237.005-2.772 1.917-2.337 3.953 0 3.953 0s2.042-2.337 3.959 0c.44.534.661 1.84.003 2.772z"/><path fill="#FFF" d="M11.313 39.298c-.601.008-1.202.008-1.802 0-.114-.002-.175.024-.206.089a.28.28 0 01.165-.037c.601.008 1.201.008 1.801 0 .178-.002.233.06.23.233-.008.476-.003.952-.003 1.428.001.467-.005.933.003 1.399a.4.4 0 01-.022.166c.053-.042.066-.114.064-.219-.008-.466-.003-.933-.003-1.399 0-.476-.005-.952.003-1.428.003-.173-.053-.236-.23-.232z"/></g></switch></svg>
        </b-navbar-item>
      </template>
      <template slot="start">
        <b-navbar-item class="mx-5" tag="router-link" to="/">
          首頁
        </b-navbar-item>
        <b-navbar-item tag="router-link" class="mx-5" to="/about">
          關於讀心
        </b-navbar-item>
        <!-- <b-navbar-dropdown hoverable label="心理測驗" class="mx-5 is-hoverable">
          <b-navbar-item tag="router-link" to="/test">
            所有測驗
          </b-navbar-item>
          <b-navbar-item tag="router-link" to="#">
            開始測驗
          </b-navbar-item>
        </b-navbar-dropdown> -->
        <b-navbar-item tag="router-link" class="mx-5" to="/testList">
          心理測驗
        </b-navbar-item>
        <b-navbar-item tag="router-link" class="mx-5" to="/knowledge">
          小知識
        </b-navbar-item>
        <b-navbar-item
          tag="router-link"
          class="mx-5 nav_backStage"
          v-if="user.authority === '管理者'"
          to="/backstage"
        >
          後台管理
        </b-navbar-item>
        <b-navbar-item tag="router-link" class="mx-5" to="/test/000">
          暫放：開始測驗
        </b-navbar-item>
      </template>
      <template slot="end">
        <div
          id="avator_block"
          v-if="user.id.length > 0"
          class="mx-3 nav_avator"
          @click="toPersonalPage()"
        >
          <img
            v-if="user.avator === 'bear'"
            class="image is-55x55"
            src="./assets/images/avator/bear.png"
            alt="Your avator."
          />
          <img
            v-else-if="user.avator === 'fox'"
            class="image is-55x55"
            src="./assets/images/avator/fox.png"
            alt="Your avator."
          />
          <img
            v-else-if="user.avator === 'deer'"
            class="image is-55x55"
            src="./assets/images/avator/deer.png"
            alt="Your avator."
          />
          <img
            v-else
            class="image is-55x55"
            src="./assets/images/avator/owl.png"
            alt="Your avator."
          />
        </div>
        <b-navbar-item tag="div">
          <div class="buttons">
            <b-button
              tag="router-link"
              to="/registered"
              type="nav_signUp"
              v-if="user.id.length === 0"
            >
              <strong>Sign up</strong>
            </b-button>
            <b-button
              tag="router-link"
              to="/login"
              type="nav_logIn"
              v-if="user.id.length === 0"
            >
              <strong>Log in</strong>
            </b-button>
            <!-- <b-button
              tag="router-link"
              to="/personal"
              type="nav_signUp"
              v-if="user.id.length > 0"
            >
              <strong>會員專區</strong>
            </b-button> -->
            <b-button
              type="nav_logIn"
              @click="logout"
              v-if="user.id.length > 0"
            >
              <strong>Log out</strong>
            </b-button>
          </div>
        </b-navbar-item>
      </template>
    </b-navbar>
    <router-view />
    <!-- footer -->
    <footer>
      <div class="content has-text-centered footer p-0">
        <p>
          <strong class="has-text-primary">&copy; 2020 Read your mind </strong>
        </p>
      </div>
    </footer>
  </div>
</template>

<script>
export default {
  name: 'App',
  data() {
    return {
      users: []
    }
  },
  computed: {
    user() {
      return this.$store.state.user
    }
  },
  methods: {
    toPersonalPage() {
      if (this.$route.path !== '/personal') {
        this.$router.push('/personal')
      }
    },
    logout() {
      this.axios
        .delete(process.env.VUE_APP_API + '/users/logout')
        .then(res => {
          // 如果登出成功
          if (res.data.success) {
            this.$buefy.dialog.alert({
              title: 'Success!',
              message: '登出成功！',
              type: 'is-danger',
              hasIcon: true,
              icon: 'heart-circle-outline'
            })

            // 清除 vuex
            this.$store.commit('logout')

            // 導回首頁
            if (this.$route.path !== '/') {
              this.$router.push('/')
            }
          } else {
            this.$buefy.dialog.alert({
              title: 'Error!',
              message: res.data.message,
              type: 'is-danger',
              hasIcon: true,
              icon: 'heart-broken'
            })
          }
        })
        .catch(error => {
          // 如果回來的狀態碼不是 200，直接 alert 錯誤訊息
          this.$buefy.dialog.alert({
            title: 'Error!',
            message: error.response.data.message,
            type: 'is-danger',
            hasIcon: true,
            icon: 'heart-broken'
          })
        })
    },
    heartbeat() {
      this.axios
        .get(process.env.VUE_APP_API + '/users/heartbeat')
        .then(res => {
          // 如果 vuex 是登入中
          if (this.user.id.length > 0) {
            // 但是後端沒登入
            if (!res.data) {
              this.$buefy.dialog.alert({
                title: 'Error!',
                message: '登入時效已過，請重新登入。',
                type: 'is-danger',
                hasIcon: true,
                icon: 'heart-broken'
              })
              // 登出
              this.$store.commit('logout')
              // 導回首頁
              if (this.$route.path !== '/') {
                this.$router.push('/')
              }
            }
          }
        })
        .catch(() => {
          this.$buefy.dialog.alert({
            title: 'Error!',
            message: '發生錯誤！',
            type: 'is-danger',
            hasIcon: true,
            icon: 'heart-broken'
          })
          // 登出
          this.$store.commit('logout')
          // 導回首頁
          if (this.$route.path !== '/') {
            this.$router.push('/')
          }
        })
    }
  },
  mounted() {
    this.heartbeat()
    setInterval(() => {
      this.heartbeat()
    }, 5000)
  }
}
</script>
